<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Poker test123host</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Texas Holdâ€™em â€” test123host</h1>
    <p class="small">Share this URL with players: <span class="badge" id="joinUrl"></span></p>

    <div class="row" style="margin-top:12px">
      <div class="col">
        <div class="table">
          <div><span class="label">Hand</span> <span id="handId" class="badge">â€”</span></div>
          <div><span class="label">Stage</span> <span id="stage" class="badge">lobby</span></div>
          <div><span class="label">Pot</span> <span id="pot" class="badge">0</span></div>
          <div><span class="label">Dealer</span> <span id="dealer" class="badge">â€”</span></div>
          <div><span class="label">Acting</span> <span id="acting" class="badge">â€”</span></div>
          <div><span class="label">Min Raise To</span> <span id="minRaise" class="badge">â€”</span></div>
          <div><span class="label">Community</span> <div id="community" class="community">â€”</div></div>

          <div style="margin-top:8px;">
            <span class="label">Pot Breakdown (preview)</span>
            <div id="sidePots" class="list small">â€”</div>
          </div>

          <div style="margin-top:10px;">
            <button id="startBtn">Start Game</button>
            <button id="nextHandBtn">Force Next Hand</button>
            <button id="forceStageBtn" title="Advance one street (preflopâ†’flopâ†’turnâ†’riverâ†’showdown)">Force Next Stage</button>
            <button id="endGameBtn" style="background:#a00;color:#fff;">End Game (Reset)</button>

            <div id="playerList" style="margin-top:10px;"></div>

            <div style="margin-top:10px;">
              <a href="/latest-log" id="logLink" target="_blank" class="badge" style="text-decoration:none;">ðŸ“„ Download Log CSV</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <h3>Players</h3>
        <div id="players" class="list"></div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  socket.emit('test123host:join');

  // Show the join URL for players
  const joinUrl = `${location.protocol}//${location.host}/player.html`;
  document.getElementById('joinUrl').textContent = joinUrl;

  const el = id => document.getElementById(id);

  socket.on('test123host:welcome', () => {});

  socket.on('state:update', (s) => {
    el('handId').textContent   = s.handId;
    el('stage').textContent    = s.stage;
    el('pot').textContent      = s.pot;
    el('dealer').textContent   = s.dealerBtn;
    el('acting').textContent   = s.currentPlayerIdx;
    el('minRaise').textContent = s.minRaiseTo;
    el('community').textContent = (s.community && s.community.length) ? s.community.join(' ') : 'â€”';

    // Players (full info for host)
    const list = el('players');
    list.innerHTML = '';
    s.players.forEach((p) => {
      const row = document.createElement('div');
      row.className = 'player-row';
      row.innerHTML = `
        <div>
          <div><strong>${p.name}</strong> <span class="small">[seat ${p.seat}]</span></div>
          <div class="small">Cards: <span class="cards">${(p.cards && p.cards.length) ? p.cards.join(' ') : 'â€”'}</span></div>
          <div class="small">Committed: ${p.committed || 0} â€¢ ${p.allIn ? 'ALL-IN' : (p.inHand ? 'IN HAND' : 'OUT')}</div>
        </div>
        <div>
          <div class="badge">Stack: ${p.stack}</div>
          <div class="small">Bet: ${p.bet || 0} â€¢ ${p.folded ? 'FOLDED' : (p.inHand ? 'IN HAND' : 'OUT')}</div>
          <div style="margin-top:4px;">
            <input type="number" id="stack-${p.id}" placeholder="Set stack" style="width:90px;">
            <button onclick="setPlayerStack('${p.id}')">Set</button>
            <button onclick="removePlayer('${p.id}')">Remove</button>
          </div>
        </div>
      `;
      list.appendChild(row);
    });

    // Pot breakdown preview
    const sp = el('sidePots');
    if (!s.sidePots || !s.sidePots.length) {
      sp.textContent = 'â€”';
    } else {
      sp.innerHTML = s.sidePots.map((p, idx) => {
        const title = idx === 0 ? 'Main' : `Side ${idx}`;
        return `<div>${title}: <strong>${p.amount}</strong> <span class="small">(eligible: ${p.eligibleCount})</span></div>`;
      }).join('');
    }

    // Optional mini list of players with remove between hands (kept simple)
    const simpleList = s.players.map(p =>
      `<li>${p.name} â€“ ${p.stack} <button onclick="removePlayer('${p.id}')">Remove</button></li>`
    ).join('');
    document.getElementById('playerList').innerHTML = `<ul>${simpleList}</ul>`;
  });

  // Host controls
  document.getElementById('startBtn').onclick      = () => socket.emit('test123host:start');
  document.getElementById('nextHandBtn').onclick   = () => socket.emit('test123host:nextHandNow');
  document.getElementById('forceStageBtn').onclick = () => socket.emit('test123host:forceNextStage');
  document.getElementById('endGameBtn').onclick    = () => {
    if (confirm('End the current game and clear all players?')) {
      socket.emit('test123host:endGame');
    }
  };

  // Per-player actions
  function removePlayer(id) {
    socket.emit('test123host:removePlayer', id);
  }

  function setPlayerStack(id) {
    const val = parseInt(document.getElementById(`stack-${id}`).value, 10);
    if (Number.isFinite(val) && val >= 0) {
      socket.emit('test123host:setPlayerStack', { playerId: id, newStack: val });
    } else {
      alert('Enter a valid non-negative stack amount.');
    }
  }

  // Expose helpers to global scope for inline onclick
  window.removePlayer = removePlayer;
  window.setPlayerStack = setPlayerStack;
</script>
</body>
</html>
