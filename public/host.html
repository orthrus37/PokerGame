<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Poker Host</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Texas Holdâ€™em â€” Host</h1>
    <p class="small">Share this URL with players: <span class="badge" id="joinUrl"></span></p>
    <div class="row" style="margin-top:12px">
      <div class="col">
        <div class="table">
          <div><span class="label">Hand</span> <span id="handId" class="badge">â€”</span></div>
          <div><span class="label">Stage</span> <span id="stage" class="badge">lobby</span></div>
          <div><span class="label">Pot</span> <span id="pot" class="badge">0</span></div>
          <div><span class="label">Dealer</span> <span id="dealer" class="badge">â€”</span></div>
          <div><span class="label">Acting</span> <span id="acting" class="badge">â€”</span></div>
          <div><span class="label">Min Raise To</span> <span id="minRaise" class="badge">20</span></div>
          <div><span class="label">Community</span> <div id="community" class="community">â€”</div></div>

          <!-- NEW: Pot breakdown preview -->
          <div style="margin-top:8px;">
            <span class="label">Pot Breakdown (preview)</span>
            <div id="sidePots" class="list small">â€”</div>
          </div>

          <div style="margin-top:10px;">
            <button id="startBtn">Start Game</button>
            <button id="nextHandBtn">Force Next Hand</button>
            <button id="endGameBtn" style="background:#a00;color:#fff;">End Game (Reset)</button> <!-- NEW -->
            <div id="playerList" style="margin-top:8px;"></div>
            <div style="margin-top:10px;">
              <a href="/latest-log" id="logLink" target="_blank" class="badge" 
                 style="text-decoration:none;">ðŸ“„ Download Log CSV</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <h3>Players</h3>
        <div id="players" class="list"></div>
      </div>
    </div>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  socket.emit('host:join');

  const joinUrl = `${location.protocol}//${location.host}/player.html`;
  document.getElementById('joinUrl').textContent = joinUrl;

  const el = id => document.getElementById(id);

  socket.on('host:welcome', () => {});
  socket.on('state:update', (s) => {
    el('handId').textContent = s.handId;
    el('stage').textContent = s.stage;
    el('pot').textContent = s.pot;
    el('dealer').textContent = s.dealerBtn;
    el('acting').textContent = s.currentPlayerIdx;
    el('minRaise').textContent = s.minRaiseTo;
    el('community').textContent = s.community.length ? s.community.join(' ') : 'â€”';

    // Render players (full info for host)
    const list = el('players');
    list.innerHTML = '';
    s.players.forEach((p,i) => {
      const row = document.createElement('div');
      row.className = 'player-row';
      row.innerHTML = `
        <div>
          <div><strong>${p.name}</strong> <span class="small">[seat ${p.seat}]</span></div>
          <div class="small">Cards: <span class="cards">${p.cards.join(' ')||'â€”'}</span></div>
          <div class="small">Committed: ${p.committed} â€¢ ${p.allIn ? 'ALL-IN' : (p.inHand ? 'IN HAND' : 'OUT')}</div>
        </div>
        <div>
          <div class="badge">Stack: ${p.stack}</div>
          <div class="small">Bet: ${p.bet} â€¢ ${p.folded ? 'FOLDED' : (p.inHand?'IN HAND':'OUT')}</div>
        </div>
      `;
      list.appendChild(row);
    });

    // Render pot breakdown preview
    const sp = el('sidePots');
    if (!s.sidePots || !s.sidePots.length) {
      sp.textContent = 'â€”';
    } else {
      sp.innerHTML = s.sidePots.map((p, idx) => {
        const title = idx === 0 ? 'Main' : `Side ${idx}`;
        return `<div>${title}: <strong>${p.amount}</strong> <span class="small">(eligible: ${p.eligibleCount})</span></div>`;
      }).join('');
    }

    // Allow host to remove players only between hands if desired
    const listBtns = s.players.map(p =>
      `<li>${p.name} â€“ ${p.stack}
        ${(s.waitingForNextHand || s.inDelay) ? `<button onclick="remove('${p.id}')">Remove</button>` : ''}
      </li>`
    ).join('');
    document.getElementById('playerList').innerHTML = `<ul>${listBtns}</ul>`;
  });

  function remove(id) {
    socket.emit('host:removePlayer', id);
  }

  document.getElementById('startBtn').onclick = () => socket.emit('host:start');
  document.getElementById('nextHandBtn').onclick = () => socket.emit('host:nextHandNow');
  document.getElementById('endGameBtn').onclick = () => {           // NEW
    if (confirm('End the current game and clear all players?')) {
      socket.emit('host:endGame');
    }
  };
</script>
</body>
</html>
